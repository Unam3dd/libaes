#include "aes.h"
#include <stdio.h>
#include <string.h>

static void print_hex(const char *label, const uint8_t *buf, size_t size)
{
	printf("%s", label);
	for (size_t i = 0; i < size; i++) {
		printf("%02x", buf[i]);
	}
	printf("\n");
}

int main(void)
{
	aes_ctx_t ctx;
	aes_gcm_counter_t gcm_out;
	
	uint8_t key[16] = {
		0xfe, 0xff, 0xe9, 0x92, 0x86, 0x65, 0x73, 0x1c,
		0x6d, 0x6a, 0x8f, 0x94, 0x67, 0x30, 0x83, 0x08
	};
	
	// IV brut de 96 bits (12 bytes) - laissons GCM construire J0
	uint8_t iv_96[12] = {
		0xca, 0xfe, 0xba, 0xbe, 0xfa, 0xce, 0xdb, 0xad,
		0xde, 0xca, 0xf8, 0x88
	};
	
	// Construire J0 = IV || 0x00000001 (en big-endian)
	uint8_t nonce[16];
	memcpy(nonce, iv_96, 12);
	nonce[12] = 0x00;
	nonce[13] = 0x00;
	nonce[14] = 0x00;
	nonce[15] = 0x01; // Big-endian counter = 1
	
	uint8_t plaintext[64] = {
		0xd9, 0x31, 0x32, 0x25, 0xf8, 0x84, 0x06, 0xe5,
		0xa5, 0x59, 0x09, 0xc5, 0xaf, 0xf5, 0x26, 0x9a,
		0x86, 0xa7, 0xa9, 0x53, 0x15, 0x34, 0xf7, 0xda,
		0x2e, 0x4c, 0x30, 0x3d, 0x8a, 0x31, 0x8a, 0x72,
		0x1c, 0x3c, 0x0c, 0x95, 0x95, 0x68, 0x09, 0x53,
		0x2f, 0xcf, 0x0e, 0x24, 0x49, 0xa6, 0xb5, 0x25,
		0xb1, 0x6a, 0xed, 0xf5, 0xaa, 0x0d, 0xe6, 0x57,
		0xba, 0x63, 0x7b, 0x39, 0x1a, 0xaf, 0xd2, 0x55
	};
	
	uint8_t aad[20] = {
		0xfe, 0xed, 0xfa, 0xce, 0xde, 0xad, 0xbe, 0xef,
		0xfe, 0xed, 0xfa, 0xce, 0xde, 0xad, 0xbe, 0xef,
		0xab, 0xad, 0xda, 0xd2
	};
	
	uint8_t ciphertext[64] = {0};
	uint8_t tag[16] = {0};
	
	memset(&ctx, 0, sizeof(ctx));
	ctx.key_size = AES_KEY_128;
	memcpy(ctx.key.key_128, key, 16);
	
	if (aes_128_key_expansion(&ctx.key) != AES_OK) {
		return 1;
	}
	
	gcm_out.out = ciphertext;
	gcm_out.size = sizeof(ciphertext);
	
	printf("Test avec J0 = IV || 00000001 (big-endian)\n\n");
	print_hex("IV (96 bits):  ", iv_96, 12);
	print_hex("J0 construit:  ", nonce, 16);
	printf("\n");
	
	if (aes_gcm_enc(&gcm_out, nonce, aad, sizeof(aad), plaintext, sizeof(plaintext), &ctx) != AES_OK) {
		return 1;
	}
	
	_mm_storeu_si128((__m128i*)tag, gcm_out.tag);
	
	print_hex("Ciphertext:    ", ciphertext, 64);
	print_hex("Tag:           ", tag, 16);
	
	printf("\nAttendu NIST:  4d5c2af327cd64a62cf35abd2ba6fab4\n");
	printf("OpenSSL donne: da80ce830cfda02da2a218a1744f4c76\n");
	
	return 0;
}
